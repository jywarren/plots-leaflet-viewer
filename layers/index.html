<html><head> 
   
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
    <title>PLOTS Leaflet Viewer</title>
    <link rel="stylesheet" href="http://leaflet.cloudmade.com/dist/leaflet.css">
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
    <script src="http://mapknitter.org/javascripts/prototype.js"></script>

    <style>
	#link {
		font-family:lucida grande, lucida sans console, sans-serif;
		background:white;
		padding:4px;
		font-size:11px;
		position:absolute;
		bottom:0;
		left:0;
		z-index:999;
	}
	#link a {
		color:#333;
	}
    </style>
    
  </head>
  <body style="margin:0;"> 
    <div id="link"><a href="">permalink</a></div>

    <div class=" leaflet-container" id="map" style="width:100%;height:100%;"></div>
    <script src="http://leaflet.cloudmade.com/dist/leaflet.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>                                                                   
    <script src="google.js"></script>
    <script>

   function get_param(param) {
     var search = window.location.search.substring(1);
     var compareKeyValuePair = function(pair) {
       var key_value = pair.split('=');
       var decodedKey = decodeURIComponent(key_value[0]);
       var decodedValue = decodeURIComponent(key_value[1]);
       if(decodedKey == param) return decodedValue;
       return null;
     };

     var comparisonResult = null;

     if(search.indexOf('&') > -1) {
       var params = search.split('&');
       for(var i = 0; i < params.length; i++) {
         comparisonResult = compareKeyValuePair(params[i]); 
         if(comparisonResult !== null) {
            break;
         }
       }
     } else {
       comparisonResult = compareKeyValuePair(search);
     }
     return comparisonResult;
   }

   window.onload = function() {

	var tms = get_param('tms')+"{z}/{x}/{y}.png"
	var background_tms = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
	//var backdroptms = "http://hypercube.telascience.org/tilecache/tilecache.py/1.0.0/NAIP_ALL/{z}/{x}/{y}.png"
	//var backdroptms = "http://hypercube.telascience.org/tilecache/tilecache.py/1.0.0/NewWorld_google/{z}/{x}/{y}.png"
	var minZoom = get_param('min') || 15
	var maxZoom = get_param('max') || 22
	var zoom = get_param('zoom') || 18
	var layer_urls = get_param('layers').split(',') || false 
	// in the format: http://url.org/tms/#My Map,http://url.com/tms/#My Other Map
                                                                                                                   
	//var background = new L.TileLayer(background_tms, {minZoom: minZoom, maxZoom: maxZoom, scheme:"tms"});
	var google = new L.Google();
	var main = new L.TileLayer(tms, {minZoom: minZoom, maxZoom: maxZoom, scheme:"tms"});
	var layers = []
	var labels = []

	layer_urls.each(function(layer_url) {
		layers.push(new L.TileLayer(layer_url.split('#')[0], {minZoom: minZoom, maxZoom: maxZoom, scheme:"tms"}))
		labels.push(layer_url.split('#')[1])
	}
	layers.push(google)
	layers.push(main)

	var map = new L.Map('map', {
		crs:L.CRS.EPSG3857,
		layers: layers//[google,main]
	});
	map.setView(new L.LatLng(parseFloat(get_param('lat')),parseFloat(get_param('lon'))), zoom)

	var baseMaps = {
	    "Google": google
	};
	var overlayMaps = {
	    "Visible": main
	};
	layers.each(function(layer,index){
		overlayMaps[labels[index]] = layer
	})
 
	var layersControl = new L.Control.Layers(baseMaps,overlayMaps);
	map.addControl(layersControl);
    }  
    </script> 
    
  </body></html>
